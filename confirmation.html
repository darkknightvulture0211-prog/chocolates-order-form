<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Order - Chocolates with Rangani's</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Order Confirmation</h1>
        <h2>Review Your Order:</h2>

        <div id="orderDetails" class="item-list">
            </div>

        <button class="btn" onclick="submitOrder()">Confirm and Place Order</button>
    </div>

    <script>
        // --- Core Function to Display Order Details ---
        document.addEventListener("DOMContentLoaded", () => {
            const orderDetailsDiv = document.getElementById("orderDetails");
            const userDetails = JSON.parse(localStorage.getItem("userDetails"));
            const order = JSON.parse(localStorage.getItem("order"));

            if (!userDetails || !order || !order.items) {
                orderDetailsDiv.innerHTML = "<p>No order details found. Please start a new order.</p>";
                return;
            }

            let listHtml = "";

            // Display Customer Details for review
            listHtml += `<h3>Customer: ${userDetails.name} (${userDetails.email})</h3>`;
            listHtml += "<h3>Selected Items:</h3><ul>";

            // Process and Display Items
            order.items.forEach(item => {
                listHtml += `<li>${item}</li>`;
            });

            listHtml += "</ul>";
            
            // Display Membership status
            const termsAgreed = localStorage.getItem("termsAgreed") === 'Yes' ? 'Yes' : 'No';
            listHtml += `<h3>Membership Enrolled: ${termsAgreed}</h3>`;

            orderDetailsDiv.innerHTML = listHtml;
        });

        // --- Formspree Submission Function (FIXED to include Customer Name/Email) ---
        function submitOrder() {
            // Retrieve ALL necessary data from localStorage
            const userDetails = JSON.parse(localStorage.getItem("userDetails"));
            const order = JSON.parse(localStorage.getItem("order"));
            const signature = localStorage.getItem("signature");
            const termsAgreed = localStorage.getItem("termsAgreed");
            const membershipName = localStorage.getItem("membershipName");

            // Basic check to ensure we have the necessary details
            if (!userDetails || !userDetails.name || !userDetails.email || !order) {
                alert("Cannot submit order: Missing customer or order details. Please restart the order process.");
                return;
            }

            // Combine all data for Formspree
            const formData = new FormData();
            
            // *** FIX: ENSURE NAME AND EMAIL ARE SENT FROM userDetails ***
            formData.append('Customer Name', userDetails.name);
            formData.append('Customer Email', userDetails.email);
            
            formData.append('Items Ordered', order.items.join(', '));
            
            // Include membership details
            formData.append('Membership Name (Enrolled)', membershipName || 'N/A');
            formData.append('Membership Signature', signature || 'N/A');
            formData.append('Terms Agreed', termsAgreed || 'No');

            // Replace 'xvgveojw' with your actual Formspree endpoint ID
            const formspreeUrl = 'https://formspree.io/f/xvgveojw'; 

            fetch(formspreeUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert("Order placed successfully! Redirecting to Thank You page.");
                    localStorage.clear(); // Clear all order data
                    window.location.href = "checkout.html";
                } else {
                    alert("There was an issue submitting the order. Please try again.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred during submission.");
            });
        }
    </script>
</body>
</html>